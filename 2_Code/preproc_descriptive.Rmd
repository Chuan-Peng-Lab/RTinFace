---
title: "Preprocessing & Descriptive Analysis"
author: "hcp4715"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: html_document
---

# About the data

## The full dataset form PSA001

Script: `psa001_RR2_analysis.Rmd`

1.  Joining three data files `psa001_exp_data.csv`, `psa001_session.csv`, and `psa001_quest_data.csv` to `psa001_rating_raw.csv`.

2.  Joining the above data with data from Oosterhof & Todorov, (2008);

3.  Excluded invalid data and got `psa001_ind.csv`, but note the rating could not be used in our analysis because they used averaged rating from two ratings of the same subject.

The final subject should be "11,481 participants (69.6% women, 29.7% men, 0.7% other; mean age = 22.6 years), nested within 45 countries, nested within 11 regions," from Hester, Xie, & Hehman (2021).

Exploratory dataset was generated by `psa001_RR2_subset.Rmd`, using the exactly same procedure as above. The final valid subjects are 4143.

The first conclusion: we should not use either "psa001_ind_subset.csv" or "psa001_ratings_raw_subset.csv", because the former used averaged RT while the latter did not exclude invalid data. Instead, we should start with "psa001_ratings_raw_subset.csv" but not join it with data from Oosterhof & Todorov, (2008), and exclude invalid data.

```{r}
# install pacman if not installed yet
if (!require("pacman")) install.packages("pacman")

# use pacman::p_load to load or install tidyverse
pacman::p_load(tidyverse)
```

### Load the "psa001_ratings_raw_subset.csv"

```{r}
df_raw_subset <- read.csv(here::here("1_data", "ExploratoryData", "data", "psa001_ratings_raw_subset.csv"))

regions <- read.csv(here::here("1_data", "ExploratoryData", "data", "regions.csv"))
```

### Load Stimulus Info

```{r load-stim-info}
stim_info <- read_csv(here::here("1_data", "ExploratoryData", "data", "psa001_cfd_faces.csv")) %>%
      dplyr::mutate(ethnicity = recode(Race, "A" = "asian", "B" = "black", "L" = "latinx", "W" = "white"),
                    gender = recode(Gender, "M" = "male", "F" = "female")
                    )

stim_info %>%
      group_by(ethnicity, gender) %>%
      summarise(n = n(),
                mean_age = round(mean(Age), 2),
                sd_age = round(sd(Age), 2)
                ) %>%
      knitr::kable("html") %>%
      kableExtra::kable_styling("striped")

stim_n_male <- sum(stim_info$gender == "male")
stim_n_female <- sum(stim_info$gender == "female")
mean_age <- mean(stim_info$Age) %>% round(2)
sd_age <- sd(stim_info$Age) %>% round(2)
min_age <- min(stim_info$Age)
max_age <- max(stim_info$Age)
```

Stimuli in our study will be an open-access, full-color, face image set consisting of `r stim_n_male` men and `r stim_n_female` women (mean age=`r mean_age` years, SD=`r sd_age` years, range=`r min_age` to `r max_age` years), taken under standardized photographic conditions (Ma et al., 2015).

### Add region information to the data

```{r join with region}
df_subset <- df_raw_subset %>%
  rename(qcountry = country) %>%
  separate(lab, c("country", "lab")) %>%
  left_join(regions, by = "country") 

# df_regions <- df_full %>% 
#   dplyr::mutate(lab  = substr(lab, 1, nchar(lab)- 4)) %>% 
#   dplyr::mutate(country = lab) %>% 
#   dplyr::left_join(regions, by = "country")
```

### Graph distributions for trait by region

```{r plot-styles}
# plot styles
bgcolor <- "white"
textcolor <- "black"
PSA_theme <- theme(
    plot.background = element_rect(fill = bgcolor, color = NA),
    panel.background = element_rect(fill = NA, color = "grey"),
    legend.background = element_rect(fill = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    text = element_text(color = textcolor, size=15),
    axis.text = element_text(color = textcolor, size=10),
    strip.text.y = element_text(angle = 0, hjust = 0)
  )
```

```{r trait-by-region-plot, fig.width=15, fig.height=6}
ggplot2::ggplot(df_subset, aes(rating, fill = trait)) +
      geom_histogram(binwidth = 1, color = "grey", show.legend = F) +
      facet_grid(region ~ trait, space = "free") +
      scale_x_continuous(breaks = 1:9) +
      PSA_theme
```

### remove invalid participants

```{r}
identical_rating_threshold <- 0.75 * 120 # use this for registered analyses

inv_participants <- df_subset %>%
      filter(block == 1) %>%
      count(user_id, region, trait, rating) %>%
      group_by(user_id, region, trait) %>%
      filter(n == max(n)) %>%                  # find most common rating for each P
      ungroup() %>%
      filter(n >= identical_rating_threshold)  # dplyr::select Ps who gave the same rating to >= 75% of stimuli, 219 participants


df_valid_subset <- df_subset %>%
      group_by(user_id, trait) %>%
      filter(# did not complete 1+ ratings for each of 120 stimuli
            dplyr::n_distinct(stim_id) == 120,  
            !is.na(region)   # did not specify region (none expected)
            ) %>%
      anti_join(inv_participants, by = "user_id") 

```

## Participant Demographics

Total: 4143

```{r demog-language}
df_valid_subset %>%
      group_by(user_id, language) %>%
      summarise() %>%
      ungroup() %>%
      group_by(language) %>%
      summarise(n = n()) %>%
      knitr::kable("html") %>%
      kableExtra::kable_styling("striped")
```

```{r demog-region}
by_region <- df_valid_subset %>%
  group_by(user_id, region) %>%
  summarise() %>%
  ungroup() %>%
  group_by(region) %>%
  summarise(n = n()) %>%
  add_row(region = "TOTAL", n = n_distinct(df_valid_subset$user_id)) %>%
  knitr::kable("html") %>%
  kableExtra::kable_styling("striped")

# save_kable(by_region, "figures/n_by_region.html")
           
by_region
```

### Age and sex distribution per region

```{r age-sex-plot, fig.width=12, fig.height=10}
df_valid_subset %>%
  group_by(user_id, sex, age, region) %>%
  summarise() %>%
  ungroup() %>%
  group_by(region) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  ggplot(aes(as.numeric(age), fill = sex)) +
  geom_histogram(binwidth = 5, color = "grey") +
  geom_text(aes(x=0, y=5, label = paste0("n=",n)), color = "black") +
  labs(title="", y="", x="Participant age in 5-year bins") +
  facet_grid(region~., scales="free_y") +
  PSA_theme
```

### Participants per trait per region

```{r n-trait-region-plot, fig.width=15, fig.height=10.5}
df_valid_subset %>%
  group_by(trait, region) %>%
  summarise(n = n_distinct(user_id)) %>%
  ggplot(aes(trait, n)) +
  geom_col(aes(fill = trait), show.legend = F) +
  geom_hline(yintercept = 15) +
  facet_grid(region~., scale = "free") +
  labs(title="", x="", y="Participants per trait per region") +
  theme( axis.text.x = element_text(angle = -45, hjust = 0) ) + 
  PSA_theme

# ggsave("figures/participants_per_trait_per_region.png", width = 15, height = 8)
```

### Participants per lab

```{r n-per-lab}
labs <- df_valid_subset %>%
  unite(lab, country, lab) %>%
  group_by(region, lab, user_id) %>%
  summarise() %>%
  ungroup() %>%
  count(region, lab) %>%
  arrange(region, lab)

knitr::kable(labs) %>%
  kableExtra::kable_styling("striped")
```


### joint the stim info into the dataframe.
```{r join the stim info}
stim_info_simple <- stim_info %>%
      dplyr::select(-Gender, -Race) %>%
      # column names to lower case
      dplyr::rename_all(tolower) %>%
      # add prefixe "stim_" to all columns except "stim_id"
      dplyr::rename_all(~paste0("stim_", .)) %>%
      dplyr::rename(stim_id = stim_target)
      

df_valid_subset <- df_valid_subset %>%
  left_join(stim_info_simple, by = c("stim_id"))
```